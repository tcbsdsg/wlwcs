<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能药盒管理系统</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- [预留] 真实扫码功能依赖库 QuaggaJS -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="app-container">
        <!-- 顶部导航 -->
        <header>
            <div class="logo">
                <i class="fas fa-briefcase-medical"></i> 智能药盒
            </div>
        </header>

        <!-- 全局紧急求助按钮 -->
        <div id="emergency-bar">
            <button id="emergency-btn" class="btn-danger full-width">
                <i class="fas fa-heartbeat"></i> 紧急求助 (SOS)
            </button>
        </div>

        <main>
            <!-- 页面 1: 首页 (Home) -->
            <div id="page-home" class="page active">
                <!-- 温湿度显示 -->
                <section id="env-sensor" class="card env-card">
                    <div class="sensor-item">
                        <div class="sensor-icon temp"><i class="fas fa-temperature-high"></i></div>
                        <div class="sensor-info">
                            <span class="sensor-label">室内温度</span>
                            <span class="sensor-value" id="val-temp">--°C</span>
                        </div>
                    </div>
                    <div class="sensor-divider"></div>
                    <div class="sensor-item">
                        <div class="sensor-icon humidity"><i class="fas fa-tint"></i></div>
                        <div class="sensor-info">
                            <span class="sensor-label">室内湿度</span>
                            <span class="sensor-value" id="val-humidity">--%</span>
                        </div>
                    </div>
                </section>

                <!-- 药盒状态 -->
                <section id="box-status" class="card">
                    <h2><i class="fas fa-boxes"></i> 当前药盒 (3格)</h2>
                    <div class="slots-container">
                        <div class="slot" id="slot-1">
                            <div class="slot-header">药格 1</div>
                            <div class="slot-content">
                                <span class="med-name">空置</span>
                                <span class="med-status">--</span>
                            </div>
                        </div>
                        <div class="slot" id="slot-2">
                            <div class="slot-header">药格 2</div>
                            <div class="slot-content">
                                <span class="med-name">空置</span>
                                <span class="med-status">--</span>
                            </div>
                        </div>
                        <div class="slot" id="slot-3">
                            <div class="slot-header">药格 3</div>
                            <div class="slot-content">
                                <span class="med-name">空置</span>
                                <span class="med-status">--</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 今日提醒 -->
                <section id="reminder-section" class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="border:none; margin:0; padding:0;"><i class="fas fa-bell"></i> 今日提醒</h2>
                        <button class="btn-primary btn-sm" id="add-reminder-btn"><i class="fas fa-plus"></i> 添加提醒</button>
                    </div>
                    <ul id="reminder-list" class="list-group">
                        <!-- 动态生成 -->
                    </ul>
                </section>
            </div>

            <!-- 页面 2: 药箱/库存 (Inventory) -->
            <div id="page-inventory" class="page">
                <!-- 录入操作 -->
                <section id="entry-section" class="card">
                    <h2><i class="fas fa-plus-circle"></i> 药品管理</h2>
                    <div class="action-buttons">
                        <button class="btn-primary" id="scan-btn"><i class="fas fa-camera"></i> 扫码识别录入</button>
                        <button class="btn-outline" id="manual-add-btn"><i class="fas fa-pen"></i> 手动录入</button>
                    </div>
                </section>

                <!-- 库存列表 -->
                <section id="inventory-section" class="card">
                    <h2><i class="fas fa-warehouse"></i> 库存列表</h2>
                    <div class="table-responsive">
                        <table id="inventory-table">
                            <thead>
                                <tr>
                                    <th>药品信息</th>
                                    <th>规格</th>
                                    <th>剩余量</th>
                                    <th>有效期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- 页面 3: 报表 (Reports) -->
            <div id="page-reports" class="page">
                <section id="report-section" class="card">
                    <h2><i class="fas fa-chart-line"></i> 健康报表</h2>
                    <div class="charts-wrapper">
                        <div class="chart-container">
                            <canvas id="consumptionChart"></canvas>
                        </div>
                        <div class="health-stats">
                            <div class="stat-item">
                                <h4>服药依从性</h4>
                                <div class="stat-value">95%</div>
                            </div>
                            <div class="stat-item">
                                <h4>最近血压</h4>
                                <p>120/80 mmHg</p>
                            </div>
                        </div>
                    </div>
                    <!-- AI 分析区域 -->
                    <div class="ai-analysis-box" style="margin-top: 20px; background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <h4><i class="fas fa-magic"></i> AI 健康分析</h4>
                        <p id="ai-health-report" style="font-size: 0.9em; color: #555; margin-top: 8px;">正在生成分析...</p>
                        <button id="refresh-report-btn" class="btn-sm btn-outline" style="margin-top: 10px;">重新分析</button>
                    </div>
                </section>
            </div>

            <!-- 页面 4: 服务 (Services) -->
            <div id="page-services" class="page">
                <section class="card">
                    <h2><i class="fas fa-cog"></i> 设置</h2>
                    <div class="settings-item">
                        <span>长辈模式 (大字版)</span>
                        <label class="switch">
                            <input type="checkbox" id="elderly-mode-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </section>

                <section id="family-section" class="card">
                    <h2><i class="fas fa-users"></i> 家庭成员管理</h2>
                    <div id="family-list" class="family-list">
                        <!-- 动态生成家庭成员 -->
                    </div>
                    <button class="btn-primary full-width" id="add-family-btn" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> 添加家庭成员
                    </button>
                </section>

                <section class="card">
                    <h2><i class="fas fa-concierge-bell"></i> 健康服务</h2>
                    <div class="service-links">
                        <button class="btn-outline" id="ai-doctor-btn"><i class="fas fa-user-nurse"></i> AI药师咨询</button>
                    </div>
                </section>

                <section class="card">
                    <h2><i class="fas fa-microchip"></i> 设备控制</h2>
                    <div class="service-links">
                        <button class="btn-outline" id="reset-fingerprint-btn"><i class="fas fa-fingerprint"></i> 重置指纹</button>
                        <button class="btn-outline" id="open-box-btn"><i class="fas fa-box-open"></i> 打开药箱</button>
                    </div>
                </section>
            </div>
        </main>

        <!-- 底部导航栏 -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-target="page-home">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </a>
            <a href="#" class="nav-item" data-target="page-inventory">
                <i class="fas fa-box-open"></i>
                <span>药箱</span>
            </a>
            <a href="#" class="nav-item" data-target="page-reports">
                <i class="fas fa-chart-pie"></i>
                <span>报表</span>
            </a>
            <a href="#" class="nav-item" data-target="page-services">
                <i class="fas fa-user-cog"></i>
                <span>服务</span>
            </a>
        </nav>

        <!-- 弹窗：紧急求助 (SOS) -->
        <div id="sos-modal" class="modal hidden" style="z-index: 3000;">
            <div class="modal-content" style="text-align: center; border-top: 5px solid #dc3545;">
                <h3 style="margin-bottom: 20px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle"></i> 紧急求助
                </h3>
                
                <!-- 步骤 1: 选择联系人 -->
                <div id="sos-step-1">
                    <p style="margin-bottom: 15px; font-size: 1.1em;">请选择要呼叫的紧急联系人：</p>
                    <div id="sos-contact-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; max-height: 250px; overflow-y: auto;">
                        <!-- 动态生成联系人按钮 -->
                    </div>
                    
                    <div class="modal-actions" style="justify-content: space-between;">
                         <button class="btn-secondary" id="sos-cancel-btn" style="flex:1; margin-right:10px;">取消</button>
                         <button class="btn-danger" id="sos-call-confirm-btn" style="flex:1;" disabled>
                            <i class="fas fa-phone"></i> 立即呼叫
                         </button>
                    </div>
                </div>

                <!-- 步骤 2: 拨号中 -->
                <div id="sos-step-2" class="hidden">
                    <div class="sos-animation" style="margin: 20px 0;">
                        <i class="fas fa-phone-volume fa-3x" style="color: #dc3545; animation: pulse 1.5s infinite;"></i>
                    </div>
                    <p id="sos-status-text" style="font-size: 1.2em; margin-bottom: 30px;">
                        正在拨打...
                    </p>
                    <div class="modal-actions" style="justify-content: center;">
                        <button class="btn-danger" id="sos-end-btn" style="min-width: 120px;">挂断</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 弹窗：健康异常报警 -->
        <div id="health-alert-modal" class="modal hidden" style="z-index: 2000;">
            <div class="modal-content" style="border-top: 5px solid #dc3545; background-color: #fff5f5;">
                <h3 style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> 健康预警</h3>
                <p style="font-size: 1.1em; margin: 20px 0;">
                    药箱语音助手检测到用户<strong>身体不适</strong>！<br>
                    <span style="font-size: 0.9em; color: #666;">请立即确认用户状况。</span>
                </p>
                <div class="modal-actions">
                    <button class="btn-danger full-width" id="confirm-alert-btn">我已知晓，立即处理</button>
                </div>
            </div>
        </div>

        <!-- 弹窗：手动录入 -->
        <div id="add-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3>录入新药品</h3>
                <form id="add-med-form">
                    <div class="form-group">
                        <label>通用名</label>
                        <input type="text" id="med-name" required placeholder="如：阿莫西林">
                    </div>
                    <div class="form-group">
                        <label>存放位置</label>
                        <select id="med-slot">
                            <option value="1">药格 1</option>
                            <option value="2">药格 2</option>
                            <option value="3">药格 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>当前库存(粒/片)</label>
                        <input type="number" id="med-stock" required>
                    </div>
                    <div class="form-group">
                        <label>有效期</label>
                        <input type="date" id="med-expiry" required>
                    </div>
                    <div class="form-group">
                        <label>用法用量</label>
                        <input type="text" id="med-usage" placeholder="如：每日2次，每次1片">
                    </div>
                    <button type="submit" class="btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 弹窗：摄像头扫描 -->
        <div id="camera-modal" class="modal hidden">
            <div class="modal-content camera-content">
                <span class="close-btn close-camera">&times;</span>
                <h3><i class="fas fa-camera"></i> 扫描药盒条形码</h3>
                <div class="camera-viewport">
                    <video id="camera-feed" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display:none;"></canvas>
                </div>
                <p class="camera-hint">请将条形码放入框内</p>
                <div class="modal-actions">
                    <button class="btn-secondary close-camera">取消</button>
                    <button class="btn-primary" id="capture-btn">拍照识别</button>
                </div>
            </div>
        </div>

        <!-- 弹窗：一键补货确认 -->
        <div id="buy-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3><i class="fas fa-shopping-cart"></i> 补货提醒</h3>
                <p id="buy-med-name">确认跳转至京东购买吗？</p>
                <div class="modal-actions">
                    <button class="btn-secondary close-modal">取消</button>
                    <button class="btn-primary" id="confirm-buy-btn">前往购买</button>
                </div>
            </div>
        </div>

        <!-- 弹窗：添加家庭成员 -->
        <div id="family-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3>添加家庭成员</h3>
                <form id="add-family-form">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" id="family-name" required placeholder="如：李大爷">
                    </div>
                    <div class="form-group">
                        <label>关系</label>
                        <select id="family-relation">
                            <option value="父亲">父亲</option>
                            <option value="母亲">母亲</option>
                            <option value="子女">子女</option>
                            <option value="配偶">配偶</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>电话 (选填)</label>
                        <input type="tel" id="family-phone" placeholder="用于紧急联系">
                    </div>
                    <button type="submit" class="btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 弹窗：AI 药师聊天 -->
        <div id="chat-modal" class="modal hidden">
            <div class="modal-content chat-content">
                <span class="close-btn close-chat">&times;</span>
                <h3><i class="fas fa-user-nurse"></i> AI 药师助手</h3>
                <div class="chat-container" id="chat-container">
                    <div class="chat-message bot">
                        <div class="message-bubble">您好！我是您的智能药师助手，有什么用药问题可以问我哦。</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="请输入您的问题...">
                    <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- 弹窗：添加提醒 -->
        <div id="reminder-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3>设置用药提醒</h3>
                <form id="add-reminder-form">
                    <div class="form-group">
                        <label>选择药品</label>
                        <select id="remind-med-id" required>
                            <!-- 动态填充 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>服药时间</label>
                        <input type="time" id="remind-time" required>
                    </div>
                    <div class="form-group">
                        <label>服用剂量</label>
                        <input type="text" id="remind-dosage" placeholder="如：1片" required>
                    </div>
                    <div class="form-group">
                        <label>重复频率</label>
                        <select id="remind-freq">
                            <option value="DAILY">每天</option>
                            <option value="WEEKLY">每周</option>
                            <option value="ONCE">仅一次</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary full-width">保存并同步到日历</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery 库 -->
    <!-- 使用 jQuery 1.12.4 以确保与旧版 SDK (2017) 的最佳兼容性 -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="nlecloud-sdk.js"></script>
    <script src="script.js"></script>
</body>
</html>
